---
phase: 01-css-token-engine
plan: 03
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/main/java/com/dwc/laf/css/CssVariableResolver.java
  - src/test/java/com/dwc/laf/css/CssVariableResolverTest.java
autonomous: true

must_haves:
  truths:
    - "var() references resolved to their target values including nested fallbacks"
    - "Circular variable references detected and reported as errors instead of stack overflow"
    - "Missing token references with no fallback are logged as warnings"
    - "Eager resolution: all var() references resolved upfront in single pass"
    - "Resolution produces immutable resolved map"
  artifacts:
    - path: "src/main/java/com/dwc/laf/css/CssVariableResolver.java"
      provides: "var() reference resolution with cycle detection"
      exports: ["resolve"]
      contains: "class CssVariableResolver"
    - path: "src/test/java/com/dwc/laf/css/CssVariableResolverTest.java"
      provides: "Tests for variable resolution"
      contains: "@Test"
  key_links:
    - from: "CssVariableResolver.java"
      to: "Map<String, String>"
      via: "Takes raw map, returns resolved map with all var() expanded"
      pattern: "Map<String,\\s*String>"
---

<objective>
Build the CSS variable resolver that expands all var() references in a raw token map to produce a fully-resolved string map.

Purpose: This is Pass 2 of the two-pass architecture. Given the raw token map from CssTokenParser (property -> raw value with var() references), it resolves every var() reference recursively, handles fallbacks, and detects circular references. Per user decision: eager resolution -- parse once, resolve all, catch all errors at load time.
Output: CssVariableResolver.java with resolve() method and comprehensive tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-css-token-engine/01-CONTEXT.md
@.planning/phases/01-css-token-engine/01-RESEARCH.md
@.planning/phases/01-css-token-engine/01-01-SUMMARY.md
</context>

<feature>
  <name>CSS Variable Resolver - var() Reference Resolution</name>
  <files>
    src/main/java/com/dwc/laf/css/CssVariableResolver.java
    src/test/java/com/dwc/laf/css/CssVariableResolverTest.java
  </files>
  <behavior>
    Takes a Map of String to String (raw tokens) and returns a new Map of String to String where all var() references have been expanded to their final string values.

    Input: Map from CssTokenParser.parse() -- e.g., {"--a": "red", "--b": "var(--a)", "--c": "var(--missing, blue)"}
    Output: Resolved map -- e.g., {"--a": "red", "--b": "red", "--c": "blue"}

    Cases:
    - Simple reference: {"--a": "red", "--b": "var(--a)"} -> {"--a": "red", "--b": "red"}
    - Chained reference: {"--a": "1", "--b": "var(--a)", "--c": "var(--b)"} -> all resolve to "1"
    - Fallback: {"--a": "var(--missing, blue)"} -> {"--a": "blue"}
    - Nested fallback: {"--a": "var(--missing, var(--also-missing, green))"} -> {"--a": "green"}
    - Fallback to existing: {"--x": "red", "--a": "var(--missing, var(--x))"} -> {"--a": "red"}
    - Circular A->B->A: {"--a": "var(--b)", "--b": "var(--a)"} -> both excluded from result, warning logged
    - Self-reference: {"--a": "var(--a)"} -> excluded, warning logged
    - Circular with fallback: {"--a": "var(--b, safe)", "--b": "var(--a)"} -> "--a" resolves to "safe", "--b" excluded
    - Partial var() in value: {"--a": "red", "--shadow": "0 2px var(--a)"} -> {"--shadow": "0 2px red"} (var() embedded in larger string)
    - Multiple var() in one value: {"--a": "10", "--b": "20", "--c": "var(--a) var(--b)"} -> {"--c": "10 20"}
    - HSL with var(): {"--h": "211", "--s": "100%", "--color": "hsl(var(--h), var(--s), 50%)"} -> {"--color": "hsl(211, 100%, 50%)"}
    - No var() references: {"--a": "red"} -> {"--a": "red"} (passthrough)
    - Empty map: {} -> {}
    - Missing reference no fallback: {"--a": "var(--missing)"} -> excluded, warning logged (per user decision)

    Implementation approach:
    1. For each entry in the raw map, attempt to resolve its value
    2. Resolution is recursive: if a var() target itself contains var(), resolve that first
    3. Use DFS graph coloring for cycle detection: UNVISITED, VISITING, VISITED states
    4. Parenthesis-depth counting to correctly parse nested var() fallbacks -- find matching close paren
    5. Memoize resolved values to avoid redundant work
    6. Build result map excluding any entries that could not be resolved (cycles, missing with no fallback)

    var() parsing algorithm:
    - Find "var(" in the string
    - Track parenthesis depth to find the matching ")"
    - Extract content between outer parens
    - Split on first comma (respecting nested parens) to get: variable-name and optional fallback
    - Trim both parts
    - Look up variable-name in raw map, resolve it recursively
    - If not found or circular, try fallback (also resolved recursively)
    - If neither works, the value cannot be resolved

    Error handling:
    - Circular references: detect via DFS coloring, log WARNING via JUL with property names involved, exclude from result
    - Missing references (no fallback): log WARNING via JUL, exclude from result
    - Malformed var() (no closing paren): log WARNING, keep raw string as-is
  </behavior>
  <implementation>
    CssVariableResolver as a final class with:
    - `public static Map<String, String> resolve(Map<String, String> rawTokens)` -- main entry point
    - Private helper: resolveValue(String value, Map rawTokens, Map resolved, Set visiting) for recursive resolution
    - Private helper: parseVarFunction(String value, int startIndex) to extract var() content with paren matching
    - Private helper: splitVarArgs(String varContent) to split name from fallback respecting nested parens
    - Use java.util.logging.Logger for warnings
    - Return Collections.unmodifiableMap()

    Test-first: Write all test cases BEFORE implementing. RED -> GREEN -> REFACTOR cycle.
  </implementation>
</feature>

<verification>
- `mvn test -pl . -Dtest=CssVariableResolverTest` -- all tests pass
- Circular references produce warnings (check JUL output) and are excluded
- Nested fallbacks resolve correctly through multiple levels
- HSL color patterns with var() references expand correctly
</verification>

<success_criteria>
- All var() references resolved to final string values
- Circular references detected without stack overflow, excluded with warning
- Missing references excluded with warning
- Nested fallbacks work to arbitrary depth
- Multiple var() in single value all resolved
- Result map is immutable
</success_criteria>

<output>
After completion, create `.planning/phases/01-css-token-engine/01-03-SUMMARY.md`
</output>
