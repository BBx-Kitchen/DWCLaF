---
phase: 01-css-token-engine
plan: 04
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/main/java/com/dwc/laf/css/CssColorParser.java
  - src/main/java/com/dwc/laf/css/CssDimensionParser.java
  - src/test/java/com/dwc/laf/css/CssColorParserTest.java
  - src/test/java/com/dwc/laf/css/CssDimensionParserTest.java
autonomous: true

must_haves:
  truths:
    - "HSL color values convert to java.awt.Color in sRGB color space"
    - "All CSS color formats supported: hsl/hsla, hex (3/4/6/8 digit), rgb/rgba, named colors"
    - "Modern space-separated color syntax supported alongside comma-separated"
    - "Dimension values with units (rem, px, em) convert to numeric Java values"
    - "Malformed color/dimension values return empty Optional, not exceptions"
  artifacts:
    - path: "src/main/java/com/dwc/laf/css/CssColorParser.java"
      provides: "CSS color string to java.awt.Color conversion"
      exports: ["parse"]
      contains: "class CssColorParser"
    - path: "src/main/java/com/dwc/laf/css/CssDimensionParser.java"
      provides: "CSS dimension string to numeric value conversion"
      exports: ["parse"]
      contains: "class CssDimensionParser"
  key_links:
    - from: "CssColorParser.java"
      to: "NamedCssColors.java"
      via: "Falls through to named color lookup when no format matches"
      pattern: "NamedCssColors\\.resolve"
    - from: "CssColorParser.java"
      to: "CssValue.ColorValue"
      via: "Returns ColorValue wrapping parsed Color"
      pattern: "ColorValue"
    - from: "CssDimensionParser.java"
      to: "CssValue.DimensionValue"
      via: "Returns DimensionValue with parsed float and unit"
      pattern: "DimensionValue"
---

<objective>
Build the CSS value parsers that convert resolved CSS value strings into typed Java objects: colors to java.awt.Color and dimensions to numeric values.

Purpose: These are the Pass 3 type-conversion functions. After var() resolution produces plain strings, these parsers detect the value type and convert to CssValue records. Colors are the most complex due to the many CSS color formats; dimensions are simpler but important for spacing/sizing tokens.
Output: CssColorParser.java and CssDimensionParser.java with comprehensive tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-css-token-engine/01-CONTEXT.md
@.planning/phases/01-css-token-engine/01-RESEARCH.md
@.planning/phases/01-css-token-engine/01-01-SUMMARY.md
</context>

<feature>
  <name>CSS Color Parser - All CSS Color Formats to java.awt.Color</name>
  <files>
    src/main/java/com/dwc/laf/css/CssColorParser.java
    src/test/java/com/dwc/laf/css/CssColorParserTest.java
    src/main/java/com/dwc/laf/css/CssDimensionParser.java
    src/test/java/com/dwc/laf/css/CssDimensionParserTest.java
  </files>
  <behavior>
    **CssColorParser** -- Parse CSS color strings into java.awt.Color.

    Input: String (resolved CSS value, no more var() references)
    Output: Optional of java.awt.Color

    Color format cases (all must be supported per user decision):

    HSL/HSLA (primary DWC format):
    - "hsl(211, 100%, 50%)" -> Color in sRGB (blue tone)
    - "hsla(211, 100%, 50%, 0.5)" -> Color with alpha 128
    - "hsl(211 100% 50%)" -> modern space-separated syntax
    - "hsl(211 100% 50% / 0.5)" -> modern with alpha using slash
    - "hsl(0, 0%, 100%)" -> white
    - "hsl(0, 0%, 0%)" -> black

    HSL conversion algorithm (NOT HSB -- Java only has HSB built-in, must hand-write HSL):
    1. Normalize: H to 0-360, S to 0-1, L to 0-1
    2. If S == 0: R = G = B = L (achromatic)
    3. Else: q = L < 0.5 ? L * (1 + S) : L + S - L * S; p = 2 * L - q
    4. R = hueToRgb(p, q, H/360 + 1/3); G = hueToRgb(p, q, H/360); B = hueToRgb(p, q, H/360 - 1/3)
    5. hueToRgb(p, q, t): if t < 0 add 1, if t > 1 subtract 1; if t < 1/6 return p + (q-p)*6*t; if t < 1/2 return q; if t < 2/3 return p + (q-p)*(2/3-t)*6; return p
    6. Convert R, G, B from 0-1 to 0-255, clamp

    Hex:
    - "#f00" -> Color(255, 0, 0) -- 3-digit
    - "#ff0000" -> Color(255, 0, 0) -- 6-digit
    - "#ff000080" -> Color(255, 0, 0, 128) -- 8-digit with alpha
    - "#f008" -> Color(255, 0, 0, 136) -- 4-digit with alpha

    RGB/RGBA:
    - "rgb(255, 0, 0)" -> Color(255, 0, 0)
    - "rgba(255, 0, 0, 0.5)" -> Color(255, 0, 0, 128)
    - "rgb(255 0 0)" -> modern space-separated
    - "rgb(255 0 0 / 0.5)" -> modern with alpha

    Named colors:
    - "red" -> Color(255, 0, 0) -- delegates to NamedCssColors.resolve()
    - "transparent" -> Color(0, 0, 0, 0)
    - "aliceblue" -> Color(240, 248, 255)

    Edge cases:
    - Whitespace around values: " hsl( 211 , 100% , 50% ) " -> parsed correctly
    - Case insensitive: "HSL(211, 100%, 50%)" -> works
    - Percentage alpha: "rgba(255, 0, 0, 50%)" -> alpha = 128
    - Out of range clamped: "rgb(300, -10, 0)" -> Color(255, 0, 0)
    - Not a color: "16px" -> Optional.empty()
    - Empty/null: -> Optional.empty()

    **CssDimensionParser** -- Parse CSS dimension strings into CssValue records.

    Input: String (resolved CSS value)
    Output: Optional of CssValue (DimensionValue, IntegerValue, or FloatValue)

    Cases:
    - "16px" -> DimensionValue(16.0, "px")
    - "0.875rem" -> DimensionValue(0.875, "rem")
    - "1.5em" -> DimensionValue(1.5, "em")
    - "50%" -> DimensionValue(50.0, "%")
    - "400" -> IntegerValue(400) -- pure integer, no unit (font-weight)
    - "1.25" -> FloatValue(1.25) -- unitless float (line-height)
    - "0" -> IntegerValue(0)
    - "solid" -> Optional.empty() -- not a dimension
    - "" -> Optional.empty()
    - "calc(var(--size-m) / 2)" -> Optional.empty() -- calc() not evaluated, per discretion decision store as RawValue upstream
    - "1px" -> DimensionValue(1.0, "px")

    rem to px conversion: NOT done here -- DimensionValue stores the raw value and unit. The conversion to pixels (at 14px base per research recommendation) happens at consumption time in Phase 2 UIDefaults bridge. This keeps the parser layer pure.
  </behavior>
  <implementation>
    **CssColorParser** as a final class with:
    - `public static Optional<Color> parse(String value)` -- main entry point, tries each format in order
    - Private methods: parseHsl(), parseRgb(), parseHex(), each returning Optional of Color
    - Private hslToRgb(float h, float s, float l) and hueToRgb(float p, float q, float t) for HSL math
    - Falls through to NamedCssColors.resolve() as last resort
    - Use java.util.logging.Logger for malformed values

    **CssDimensionParser** as a final class with:
    - `public static Optional<CssValue> parse(String value)` -- tries to parse as dimension, integer, or float
    - Regex or character scanning to split numeric part from unit part
    - Returns DimensionValue if unit present, IntegerValue if pure integer, FloatValue if unitless decimal
    - Returns Optional.empty() for non-numeric strings

    Test-first: Write ALL test cases for both parsers BEFORE implementing either. RED -> GREEN -> REFACTOR.
  </implementation>
</feature>

<verification>
- `mvn test -pl . -Dtest="CssColorParserTest,CssDimensionParserTest"` -- all tests pass
- HSL colors match expected RGB values within tolerance of +/-1 per channel (floating point)
- All hex formats parse correctly including alpha channel
- Named colors delegate to NamedCssColors correctly
- Dimension parser distinguishes px/rem/em/% units
- Pure integers and floats detected correctly
</verification>

<success_criteria>
- CssColorParser handles all CSS color formats: hsl, hsla, rgb, rgba, hex (3/4/6/8), named
- HSL-to-RGB conversion is correct (hand-written, not using Java HSB)
- Modern space-separated and comma-separated syntaxes both work
- CssDimensionParser extracts numeric value and unit from dimension strings
- Both parsers return Optional.empty() for unrecognized input (no exceptions)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-css-token-engine/01-04-SUMMARY.md`
</output>
