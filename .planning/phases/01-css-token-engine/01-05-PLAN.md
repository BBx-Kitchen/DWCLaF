---
phase: 01-css-token-engine
plan: 05
type: execute
wave: 3
depends_on: ["01-02", "01-03", "01-04"]
files_modified:
  - src/main/java/com/dwc/laf/css/CssValueTyper.java
  - src/main/java/com/dwc/laf/css/CssTokenMap.java
  - src/main/java/com/dwc/laf/css/CssThemeLoader.java
  - src/test/java/com/dwc/laf/css/CssValueTyperTest.java
  - src/test/java/com/dwc/laf/css/CssThemeLoaderTest.java
  - src/test/java/com/dwc/laf/css/CssTokenMapTest.java
autonomous: true

must_haves:
  truths:
    - "Parser loads CSS from classpath resources (bundled in JAR)"
    - "Parser loads CSS from external file paths (user override)"
    - "External CSS tokens override matching keys, bundled provides defaults (merge overlay model)"
    - "External override path specified via system property -Ddwc.theme=/path/to/override.css"
    - "Complete pipeline: parse -> resolve -> type produces immutable CssTokenMap"
    - "CssTokenMap provides typed access to tokens by name"
  artifacts:
    - path: "src/main/java/com/dwc/laf/css/CssValueTyper.java"
      provides: "Maps resolved string values to CssValue typed records"
      contains: "class CssValueTyper"
    - path: "src/main/java/com/dwc/laf/css/CssTokenMap.java"
      provides: "Immutable typed token map -- public API for downstream consumers"
      exports: ["getColor", "getDimension", "getString", "get"]
      contains: "class CssTokenMap"
    - path: "src/main/java/com/dwc/laf/css/CssThemeLoader.java"
      provides: "Load CSS from classpath/file, merge layers, produce CssTokenMap"
      exports: ["load", "loadFromClasspath", "loadFromFile"]
      contains: "class CssThemeLoader"
  key_links:
    - from: "CssThemeLoader.java"
      to: "CssTokenParser.java"
      via: "Calls CssTokenParser.parse() on CSS text"
      pattern: "CssTokenParser\\.parse"
    - from: "CssThemeLoader.java"
      to: "CssVariableResolver.java"
      via: "Calls CssVariableResolver.resolve() on raw tokens"
      pattern: "CssVariableResolver\\.resolve"
    - from: "CssValueTyper.java"
      to: "CssColorParser.java"
      via: "Attempts color parsing for each resolved value"
      pattern: "CssColorParser\\.parse"
    - from: "CssValueTyper.java"
      to: "CssDimensionParser.java"
      via: "Attempts dimension parsing for each resolved value"
      pattern: "CssDimensionParser\\.parse"
    - from: "CssThemeLoader.java"
      to: "CssTokenMap.java"
      via: "Produces CssTokenMap as final output"
      pattern: "CssTokenMap"
    - from: "CssThemeLoader.java"
      to: "System.getProperty"
      via: "Reads dwc.theme system property for external override path"
      pattern: "System\\.getProperty.*dwc\\.theme"
---

<objective>
Wire together all parsing components into the public API: CssThemeLoader loads CSS files, runs the parse-resolve-type pipeline, and produces an immutable CssTokenMap that downstream phases consume.

Purpose: This plan integrates all prior components (parser, resolver, color/dimension parsers) into the complete end-to-end pipeline. CssThemeLoader is the entry point Phase 2 (UIDefaults Bridge) will call. CssTokenMap is the typed token store every component delegate will query.
Output: CssValueTyper, CssTokenMap, CssThemeLoader with full integration tests proving the pipeline works end-to-end.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-css-token-engine/01-CONTEXT.md
@.planning/phases/01-css-token-engine/01-RESEARCH.md
@.planning/phases/01-css-token-engine/01-01-SUMMARY.md
@.planning/phases/01-css-token-engine/01-02-SUMMARY.md
@.planning/phases/01-css-token-engine/01-03-SUMMARY.md
@.planning/phases/01-css-token-engine/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CssValueTyper and CssTokenMap</name>
  <files>
    src/main/java/com/dwc/laf/css/CssValueTyper.java
    src/main/java/com/dwc/laf/css/CssTokenMap.java
    src/test/java/com/dwc/laf/css/CssValueTyperTest.java
    src/test/java/com/dwc/laf/css/CssTokenMapTest.java
  </files>
  <action>
**CssValueTyper.java** -- Final class that converts a Map of String to String (resolved values) into a Map of String to CssValue (typed values). This is Pass 3 of the pipeline.

For each entry in the resolved map:
1. Try CssColorParser.parse(value) -- if present, create ColorValue
2. Try CssDimensionParser.parse(value) -- if present, use returned CssValue (DimensionValue, IntegerValue, or FloatValue)
3. If value contains commas or is a known string-type pattern (font-family stacks, border-style keywords like "solid", "none"), create StringValue
4. If value contains "calc(" or other unresolvable functions, create RawValue
5. Fallback: create RawValue with the original string

Public API: `public static Map<String, CssValue> type(Map<String, String> resolvedTokens)`
Return Collections.unmodifiableMap().

Detection heuristics for string vs raw:
- Font family: contains comma-separated names or known system font keywords -> StringValue
- CSS keywords (solid, none, inherit, initial, auto): -> StringValue
- Everything else that didn't match color or dimension: -> RawValue

**CssTokenMap.java** -- Immutable public API class wrapping the typed token map. This is what downstream code (Phase 2 UIDefaults Bridge) interacts with.

```java
public final class CssTokenMap {
    private final Map<String, CssValue> tokens;
    private final Map<String, String> rawTokens; // keep resolved strings for debugging

    // Package-private constructor (only CssThemeLoader creates these)
    CssTokenMap(Map<String, CssValue> tokens, Map<String, String> rawTokens) { ... }

    // Typed accessors
    public Optional<Color> getColor(String propertyName) { ... }
    public OptionalInt getInt(String propertyName) { ... }
    public Optional<Float> getFloat(String propertyName) { ... }
    public Optional<String> getString(String propertyName) { ... }
    public Optional<CssValue> get(String propertyName) { ... }
    public String getRaw(String propertyName) { ... } // resolved string, for debugging

    // Bulk access
    public Set<String> propertyNames() { ... }
    public int size() { ... }
    public boolean contains(String propertyName) { ... }

    // Color convenience: getColor with default
    public Color getColor(String propertyName, Color defaultValue) { ... }
    public int getInt(String propertyName, int defaultValue) { ... }
}
```

**CssValueTyperTest.java** -- Test:
- Color string "hsl(211, 100%, 50%)" types as ColorValue
- Hex "#ff0000" types as ColorValue
- Named "red" types as ColorValue
- "16px" types as DimensionValue(16, "px")
- "400" types as IntegerValue(400)
- "1.25" types as FloatValue(1.25)
- "-apple-system, sans-serif" types as StringValue
- "calc(100% - 20px)" types as RawValue
- "solid" types as StringValue

**CssTokenMapTest.java** -- Test:
- getColor() returns Color for color tokens, empty for non-color
- getInt() returns int for integer tokens, empty for non-integer
- getString() returns string for string tokens
- get() returns CssValue for any token
- contains() returns true for present, false for absent
- propertyNames() returns all names
- size() returns correct count
- getColor() with default returns default when missing
  </action>
  <verify>Run `mvn test -pl . -Dtest="CssValueTyperTest,CssTokenMapTest"` -- all tests pass.</verify>
  <done>CssValueTyper converts resolved strings to typed CssValue records. CssTokenMap provides clean typed API for downstream consumers. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create CssThemeLoader and integration tests</name>
  <files>
    src/main/java/com/dwc/laf/css/CssThemeLoader.java
    src/test/java/com/dwc/laf/css/CssThemeLoaderTest.java
  </files>
  <action>
**CssThemeLoader.java** -- The main entry point for the CSS token engine. Orchestrates the full pipeline: load -> parse -> merge -> resolve -> type -> wrap in CssTokenMap.

```java
public final class CssThemeLoader {
    private static final Logger LOG = Logger.getLogger(CssThemeLoader.class.getName());
    private static final String DEFAULT_THEME_RESOURCE = "com/dwc/laf/themes/default-light.css";
    private static final String OVERRIDE_SYSTEM_PROPERTY = "dwc.theme";

    /**
     * Load the complete theme: bundled defaults + optional external override.
     * External override path read from system property "dwc.theme".
     * Returns immutable CssTokenMap with all tokens resolved and typed.
     */
    public static CssTokenMap load() {
        // 1. Load bundled default CSS from classpath
        String bundledCss = loadResource(DEFAULT_THEME_RESOURCE);
        Map<String, String> rawTokens = CssTokenParser.parse(bundledCss);

        // 2. Check for external override via system property
        String overridePath = System.getProperty(OVERRIDE_SYSTEM_PROPERTY);
        if (overridePath != null && !overridePath.isBlank()) {
            try {
                String overrideCss = Files.readString(Path.of(overridePath));
                Map<String, String> overrideTokens = CssTokenParser.parse(overrideCss);
                // Merge: override tokens replace matching bundled tokens
                Map<String, String> merged = new LinkedHashMap<>(rawTokens);
                merged.putAll(overrideTokens);
                rawTokens = merged;
                LOG.info("Loaded override theme from: " + overridePath);
            } catch (IOException e) {
                LOG.warning("Failed to load override theme from: " + overridePath + " - " + e.getMessage());
            }
        }

        // 3. Resolve var() references
        Map<String, String> resolved = CssVariableResolver.resolve(rawTokens);

        // 4. Type the resolved values
        Map<String, CssValue> typed = CssValueTyper.type(resolved);

        // 5. Wrap in CssTokenMap
        return new CssTokenMap(typed, resolved);
    }

    /**
     * Load theme from a specific classpath resource (for testing or alternative themes).
     */
    public static CssTokenMap loadFromClasspath(String resourcePath) { ... }

    /**
     * Load theme from a specific file path (for testing or direct file loading).
     */
    public static CssTokenMap loadFromFile(Path filePath) throws IOException { ... }

    /**
     * Load theme from CSS text directly (for testing).
     */
    public static CssTokenMap loadFromString(String cssText) { ... }

    private static String loadResource(String resourcePath) {
        // Use Thread.currentThread().getContextClassLoader() for classpath loading
        // Fall back to CssThemeLoader.class.getClassLoader()
        // Read InputStream to String via new String(inputStream.readAllBytes(), StandardCharsets.UTF_8)
    }
}
```

Per user decisions:
- Two layers only: bundled defaults + one external override (no multi-layer cascade)
- External override via system property -Ddwc.theme=/path/to/override.css
- Startup-only theme loading (no runtime switching -- that method structure makes this clear)
- Merge overlay model: external overrides matching keys, bundled provides defaults

**CssThemeLoaderTest.java** -- Integration tests that prove the full pipeline works:

1. **Classpath loading test**: CssThemeLoader.loadFromClasspath("com/dwc/laf/themes/default-light.css") returns non-empty CssTokenMap with 100+ tokens
2. **String loading test**: CssThemeLoader.loadFromString(":root { --a: red; }") returns map with ColorValue for "--a"
3. **Full pipeline test**: Load test-tokens.css, verify:
   - Color tokens resolve to correct Color objects
   - var() references are resolved (not raw var() strings)
   - HSL colors produce correct Color
   - Dimension tokens produce DimensionValue
   - Integer tokens produce IntegerValue
4. **Override merge test**: Load a base CSS string and an override CSS string:
   - Base: `:root { --a: red; --b: blue; }`
   - Override: `:root { --a: green; }`
   - Result: "--a" is green (overridden), "--b" is blue (preserved from base)
5. **System property override test**: Set "dwc.theme" system property to a temp file path, verify load() merges correctly. Clean up property after test.
6. **File loading test**: Write CSS to temp file, load via loadFromFile(), verify tokens present
7. **Missing classpath resource**: loadFromClasspath("nonexistent.css") handles gracefully (returns empty map or throws clear exception)
8. **Missing override file**: Set dwc.theme to nonexistent path, verify load() still returns bundled defaults (warning logged, not fatal)
9. **End-to-end with real DWC tokens**: Load default-light.css, verify:
   - `getColor("--dwc-color-primary-50")` returns a blue-ish Color (hue ~211)
   - `getInt("--dwc-font-weight-normal")` returns 400
   - `getString("--dwc-font-family-sans")` returns string containing "apple-system" or "Roboto"
   - `getColor("--dwc-color-white")` returns Color(255, 255, 255)
   - Token count is 200+ (realistic theme)
  </action>
  <verify>Run `mvn test` -- ALL tests across all classes pass (full regression). Specifically verify `CssThemeLoaderTest` passes with all 9 test scenarios.</verify>
  <done>CssThemeLoader loads CSS from classpath and file, merges external override, runs full parse-resolve-type pipeline, and produces CssTokenMap. Integration tests prove end-to-end correctness with real DWC tokens. All 8 requirements (CSS-01 through CSS-08) are satisfied.</done>
</task>

</tasks>

<verification>
Run full test suite:
```
mvn test
```

Verify all requirements met:
- CSS-01: Parser extracts custom properties from :root and component selectors (tested in Plan 02 + integration)
- CSS-02: var() references resolved with nested fallbacks (tested in Plan 03 + integration)
- CSS-03: Circular references detected and reported (tested in Plan 03)
- CSS-04: All CSS color formats handled (tested in Plan 04 + integration)
- CSS-05: HSL colors convert to java.awt.Color in sRGB (tested in Plan 04 + integration)
- CSS-06: Numeric values with units convert to Java values (tested in Plan 04 + integration)
- CSS-07: CSS loads from classpath resource (tested in this plan)
- CSS-08: CSS loads from external file path (tested in this plan)

Additional checks:
- Zero runtime dependencies in POM (only JUnit in test scope)
- All maps returned are immutable
- All warnings logged via JUL
</verification>

<success_criteria>
- `mvn test` passes with zero failures across all test classes
- CssThemeLoader.load() produces CssTokenMap with 200+ typed tokens from bundled default
- External override merges correctly (override wins for matching keys)
- System property dwc.theme controls override path
- Missing override file is non-fatal (bundled defaults still work)
- Full pipeline: CSS text -> raw tokens -> resolved tokens -> typed CssValue map
- All 8 CSS requirements (CSS-01 through CSS-08) demonstrably satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-css-token-engine/01-05-SUMMARY.md`
</output>
