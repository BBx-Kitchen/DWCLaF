---
phase: 02-uidefaults-bridge-laf-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/com/dwc/laf/defaults/MappingType.java
  - src/main/java/com/dwc/laf/defaults/MappingTarget.java
  - src/main/java/com/dwc/laf/defaults/MappingEntry.java
  - src/main/java/com/dwc/laf/defaults/TokenMappingConfig.java
  - src/main/java/com/dwc/laf/defaults/UIDefaultsPopulator.java
  - src/main/resources/com/dwc/laf/token-mapping.properties
  - src/test/java/com/dwc/laf/defaults/TokenMappingConfigTest.java
  - src/test/java/com/dwc/laf/defaults/UIDefaultsPopulatorTest.java
autonomous: true

must_haves:
  truths:
    - "Properties file maps CSS token names to one or more Swing UIDefaults keys with type hints"
    - "One CSS token populates multiple UIDefaults keys (one-to-many mapping)"
    - "Mapping converts CssValue types to correct Java types: ColorUIResource, Integer, Float, String"
    - "Mapping configuration is external and overridable via system property without code changes"
    - "RawValue and unresolvable tokens are skipped with a log warning, not exceptions"
    - "DimensionValue tokens convert rem/em units to pixel integers using configurable base font size"
  artifacts:
    - path: "src/main/java/com/dwc/laf/defaults/MappingType.java"
      provides: "Enum of mapping target types: COLOR, INT, FLOAT, STRING, INSETS, AUTO"
      contains: "enum MappingType"
    - path: "src/main/java/com/dwc/laf/defaults/MappingTarget.java"
      provides: "Record holding UIDefaults key name and MappingType"
      contains: "record MappingTarget"
    - path: "src/main/java/com/dwc/laf/defaults/MappingEntry.java"
      provides: "Record holding CSS token name and list of MappingTarget"
      contains: "record MappingEntry"
    - path: "src/main/java/com/dwc/laf/defaults/TokenMappingConfig.java"
      provides: "Parses token-mapping.properties, supports classpath + external override"
      exports: ["loadDefault", "loadFromClasspath", "loadFromProperties", "entries"]
    - path: "src/main/java/com/dwc/laf/defaults/UIDefaultsPopulator.java"
      provides: "Populates UIDefaults table from CssTokenMap via TokenMappingConfig"
      exports: ["populate"]
    - path: "src/main/resources/com/dwc/laf/token-mapping.properties"
      provides: "Default CSS-to-UIDefaults mapping for 8 target components"
      contains: "--dwc-"
  key_links:
    - from: "src/main/java/com/dwc/laf/defaults/TokenMappingConfig.java"
      to: "src/main/resources/com/dwc/laf/token-mapping.properties"
      via: "classpath resource loading"
      pattern: "loadFromClasspath|getResourceAsStream"
    - from: "src/main/java/com/dwc/laf/defaults/UIDefaultsPopulator.java"
      to: "src/main/java/com/dwc/laf/css/CssTokenMap.java"
      via: "tokens.get() for each mapped CSS property"
      pattern: "tokens\\.get\\("
    - from: "src/main/java/com/dwc/laf/defaults/UIDefaultsPopulator.java"
      to: "javax.swing.UIDefaults"
      via: "table.put() with UIResource-wrapped values"
      pattern: "table\\.put\\("
    - from: "src/main/java/com/dwc/laf/defaults/UIDefaultsPopulator.java"
      to: "src/main/java/com/dwc/laf/defaults/TokenMappingConfig.java"
      via: "iterating mapping.entries() to drive population"
      pattern: "mapping\\.entries\\(\\)"
---

<objective>
Build the token-mapping configuration parser and UIDefaults populator that bridges Phase 1's CSS token engine to Swing's UIDefaults system.

Purpose: This is the core translation layer -- the mapping config defines WHAT CSS tokens map to WHICH Swing keys, and the populator handles HOW values are converted (CssValue -> ColorUIResource/Integer/Float/FontUIResource/InsetsUIResource). Without this, the L&F has no way to turn CSS tokens into Swing defaults.

Output: TokenMappingConfig (properties parser), UIDefaultsPopulator (conversion engine), bundled token-mapping.properties, supporting record types, and comprehensive tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-uidefaults-bridge-laf-setup/02-RESEARCH.md
@src/main/java/com/dwc/laf/css/CssValue.java
@src/main/java/com/dwc/laf/css/CssTokenMap.java
@src/main/java/com/dwc/laf/css/CssThemeLoader.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Token mapping types, config parser, and properties file</name>
  <files>
    src/main/java/com/dwc/laf/defaults/MappingType.java
    src/main/java/com/dwc/laf/defaults/MappingTarget.java
    src/main/java/com/dwc/laf/defaults/MappingEntry.java
    src/main/java/com/dwc/laf/defaults/TokenMappingConfig.java
    src/main/resources/com/dwc/laf/token-mapping.properties
    src/test/java/com/dwc/laf/defaults/TokenMappingConfigTest.java
  </files>
  <action>
Create the `com.dwc.laf.defaults` package with supporting types and the properties config parser.

**MappingType.java** -- enum with values: `COLOR`, `INT`, `FLOAT`, `STRING`, `INSETS`, `AUTO`. Include a `fromString(String)` static factory method that parses type prefix strings ("color" -> COLOR, "int" -> INT, etc.) case-insensitively, defaulting to AUTO for unknown strings.

**MappingTarget.java** -- record with fields: `String key` (the UIDefaults key name), `MappingType type`. Example: `new MappingTarget("Button.background", MappingType.COLOR)`.

**MappingEntry.java** -- record with fields: `String cssTokenName` (the CSS custom property name like "--dwc-color-primary"), `List<MappingTarget> targets` (one or more UIDefaults targets). The targets list should be unmodifiable.

**TokenMappingConfig.java** -- final class, immutable after construction:
- Private constructor taking `List<MappingEntry>`.
- `List<MappingEntry> entries()` -- returns the immutable entries list.
- `static TokenMappingConfig loadDefault()` -- loads bundled `com/dwc/laf/token-mapping.properties` from classpath, then checks system property `dwc.mapping` for external override path. If external file exists, load it and merge on top (external keys override bundled keys). Uses `java.util.Properties` for parsing (do NOT hand-roll). Follow the same classpath loading pattern as CssThemeLoader (context classloader first, then class classloader).
- `static TokenMappingConfig loadFromClasspath(String resourcePath)` -- loads from specific classpath resource, no override.
- `static TokenMappingConfig loadFromProperties(Properties props)` -- parses a Properties object into config (useful for testing).
- Private `parse(Properties)` method: iterates `stringPropertyNames()`, for each property name (the CSS token name starting with `--`), parses the value string by splitting on commas. Each comma-separated segment is trimmed, then split on the first `:` to extract type prefix and UIDefaults key. No colon = MappingType.AUTO. Creates MappingEntry with list of MappingTargets.
- Use `java.util.logging.Logger` for warnings (missing resource, missing external file).
- Missing external override file is non-fatal: log warning, use bundled defaults alone.

**token-mapping.properties** -- bundled default mapping. Format is `--css-token-name = type:UIDefaults.key, type:UIDefaults.key, ...`. Create a starter mapping covering the tokens needed for the 8 target components. Include:
```
# Global colors
--dwc-color-primary = color:Button.default.background, color:ProgressBar.foreground, color:CheckBox.icon.checkmarkColor
--dwc-color-on-primary-text = color:Button.default.foreground
--dwc-color-default = color:Button.background, color:ToggleButton.background
--dwc-color-on-default-text = color:Button.foreground, color:ToggleButton.foreground
--dwc-color-body-text = color:Label.foreground, color:text, color:textText, color:controlText
--dwc-color-white = color:TextField.background, color:TextArea.background, color:List.background, color:Table.background
--dwc-color-black = color:TextField.foreground, color:TextArea.foreground

# Surfaces
--dwc-surface-3 = color:Panel.background, color:control, color:window

# Border radius
--dwc-border-radius = int:Button.arc, int:Component.arc, int:CheckBox.arc, int:ComboBox.arc, int:TextField.arc

# Focus ring
--dwc-focus-ring-width = int:Component.focusWidth

# Typography
--dwc-font-size = int:defaultFont.size
--dwc-font-weight = int:defaultFont.style
--dwc-font-family = string:defaultFont.family

# Disabled state
--dwc-disabled-opacity = float:Component.disabledOpacity

# Border
--dwc-border-width = int:Component.borderWidth

# Button component tokens
--dwc-button-background = color:Button.background
--dwc-button-color = color:Button.foreground
--dwc-button-font-weight = int:Button.font.style
--dwc-button-hover-background = color:Button.hoverBackground

# Input component tokens
--dwc-input-background = color:TextField.background
--dwc-input-border-color = color:TextField.borderColor
--dwc-input-placeholder-color = color:TextField.placeholderForeground
--dwc-input-color = color:TextField.foreground

# Color variations for component states
--dwc-color-primary-light = color:Button.default.hoverBackground
--dwc-color-primary-dark = color:Button.default.pressedBackground
--dwc-color-danger = color:TextField.errorBorderColor, color:Component.error.focusedBorderColor
--dwc-color-default-dark = color:Button.pressedBackground
--dwc-color-default-light = color:Button.hoverBackground
```
Include comments explaining the format at the top of the file.

**TokenMappingConfigTest.java** -- test class covering:
- `loadFromProperties()` with single one-to-one mapping
- `loadFromProperties()` with one-to-many mapping (comma-separated targets)
- Type prefix parsing: "color:", "int:", "float:", "string:", "insets:"
- No type prefix defaults to AUTO
- Empty/blank target segments are skipped
- `loadFromClasspath()` loads the bundled token-mapping.properties successfully
- Bundled properties file has non-zero entries
- External override via system property merges correctly (set/clear `dwc.mapping` property in test, use temp file)
- Missing external override file logs warning but doesn't throw
  </action>
  <verify>
Run `mvn test -pl . -Dtest="com.dwc.laf.defaults.TokenMappingConfigTest" -f /Users/beff/_lab/dwclaf/pom.xml` -- all tests pass.
Also verify the bundled token-mapping.properties loads: `mvn test -pl . -Dtest="com.dwc.laf.defaults.TokenMappingConfigTest#loadDefaultReturnsNonEmptyConfig" -f /Users/beff/_lab/dwclaf/pom.xml`
  </verify>
  <done>
TokenMappingConfig parses properties file format correctly, supports one-to-many mapping with type hints, loads from classpath and supports external override via dwc.mapping system property. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: UIDefaultsPopulator with typed value conversion and UIResource wrapping</name>
  <files>
    src/main/java/com/dwc/laf/defaults/UIDefaultsPopulator.java
    src/test/java/com/dwc/laf/defaults/UIDefaultsPopulatorTest.java
  </files>
  <action>
Create the populator that reads TokenMappingConfig entries and CssTokenMap to populate a UIDefaults table.

**UIDefaultsPopulator.java** -- final utility class (private constructor):
- `public static void populate(UIDefaults table, CssTokenMap tokens, TokenMappingConfig mapping)` -- iterates `mapping.entries()`. For each entry, calls `tokens.get(entry.cssTokenName())`. If token exists, iterates `entry.targets()` and calls `convertValue()` for each target, then `table.put(target.key(), convertedValue)`. If token is missing, log at FINE level and skip.
- `private static final int DEFAULT_BASE_FONT_SIZE_PX = 16` -- used for rem/em to pixel conversion.
- `private static Object convertValue(CssValue value, MappingType type)` -- switch on type:
  - **COLOR**: If value is ColorValue, return `new ColorUIResource(value.color())`. Otherwise null.
  - **INT**: If IntegerValue, return `value.value()` (Integer, no UIResource needed for primitives). If DimensionValue, return `dimensionToPixels(dv, DEFAULT_BASE_FONT_SIZE_PX)`. If FloatValue, return `Math.round(value.value())`. Otherwise null.
  - **FLOAT**: If FloatValue, return `value.value()`. If IntegerValue, return `(float) value.value()`. Otherwise null.
  - **STRING**: If StringValue, return `value.value()`. If RawValue, return `value.raw()` (raw strings are still useful as string mappings). Otherwise null.
  - **INSETS**: For now, return null with a LOG.fine("Insets mapping not yet implemented") message. Insets require parsing "top right bottom left" from a single value -- defer to later phases when component delegates need it.
  - **AUTO**: Auto-detect from CssValue type. ColorValue -> ColorUIResource. IntegerValue -> Integer. FloatValue -> Float. DimensionValue -> dimensionToPixels. StringValue -> String. RawValue -> skip (log at FINE).
- `private static int dimensionToPixels(CssValue.DimensionValue dim, int baseFontSizePx)` -- switch on `dim.unit()`: "px" -> `dim.intValue()`, "rem"/"em" -> `Math.round(dim.value() * baseFontSizePx)`, default -> `dim.intValue()`.
- If convertValue returns null, skip the put (don't put null in UIDefaults). Log at FINE level.
- Use `java.util.logging.Logger` for all logging.

CRITICAL: All Color values placed in UIDefaults MUST be wrapped in `ColorUIResource`. All Font values in `FontUIResource`. All Insets in `InsetsUIResource`. Integer and float primitives do NOT need UIResource wrapping. This is the UIResource contract -- without it, theme switching breaks (research Pattern 2).

**UIDefaultsPopulatorTest.java** -- comprehensive tests:
- Color mapping: CssValue.ColorValue -> ColorUIResource in UIDefaults, verify instanceof ColorUIResource
- Integer mapping from IntegerValue: value preserved as Integer
- Integer mapping from DimensionValue with px: "4px" -> 4
- Integer mapping from DimensionValue with rem: "0.25rem" -> 4 (0.25 * 16)
- Integer mapping from DimensionValue with em: "1.5em" -> 24 (1.5 * 16)
- Float mapping from FloatValue: value preserved
- String mapping from StringValue: value preserved
- AUTO type detection: ColorValue -> ColorUIResource, IntegerValue -> Integer, FloatValue -> Float, DimensionValue -> int, StringValue -> String
- RawValue skipped for AUTO (returns null, not placed in UIDefaults)
- Missing CSS token: entry in mapping but token not in CssTokenMap -- skipped without error
- One-to-many: one CSS token populates multiple UIDefaults keys
- Null convertValue result: not placed in UIDefaults
- Integration test: create a small CssTokenMap via CssThemeLoader.loadFromString(), create a TokenMappingConfig via loadFromProperties(), call populate(), verify UIDefaults has expected values with correct types
  </action>
  <verify>
Run `mvn test -pl . -Dtest="com.dwc.laf.defaults.UIDefaultsPopulatorTest" -f /Users/beff/_lab/dwclaf/pom.xml` -- all tests pass.
Run full suite: `mvn test -f /Users/beff/_lab/dwclaf/pom.xml` -- all tests pass (Phase 1 + new Phase 2 tests).
  </verify>
  <done>
UIDefaultsPopulator correctly converts CssValue types to UIDefaults-compatible Java types with UIResource wrapping for Colors. Dimension unit conversion (rem/em/px -> pixels) works correctly. One-to-many mapping populates multiple UIDefaults keys from single CSS token. All tests pass including integration test with real CSS parsing.
  </done>
</task>

</tasks>

<verification>
1. `mvn test -f /Users/beff/_lab/dwclaf/pom.xml` -- full test suite passes (all Phase 1 + Phase 2 plan 01 tests)
2. TokenMappingConfig.loadDefault() loads bundled token-mapping.properties with non-zero entries
3. UIDefaultsPopulator.populate() puts ColorUIResource instances (not plain Color) for color mappings
4. One CSS token (e.g., --dwc-border-radius) maps to multiple UIDefaults keys (Button.arc, Component.arc, etc.)
5. DimensionValue "0.25em" converts to integer 4 (0.25 * 16px base)
</verification>

<success_criteria>
- Mapping layer reads properties file and produces typed config (MAP-01)
- One CSS token maps to multiple UIDefaults keys (MAP-02)
- Population produces ColorUIResource, Integer, Float, String values correctly (MAP-03)
- External override via dwc.mapping system property works (MAP-04)
- All tests pass with zero external runtime dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-uidefaults-bridge-laf-setup/02-01-SUMMARY.md`
</output>
