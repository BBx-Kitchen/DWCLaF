---
phase: 02-uidefaults-bridge-laf-setup
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/main/java/com/dwc/laf/DwcLookAndFeel.java
  - src/test/java/com/dwc/laf/DwcLookAndFeelTest.java
autonomous: true

must_haves:
  truths:
    - "DwcLookAndFeel extends BasicLookAndFeel and activates via UIManager.setLookAndFeel()"
    - "L&F loads bundled light theme CSS during initialization via CssThemeLoader"
    - "L&F populates UIDefaults from CSS tokens via the mapping layer from Plan 01"
    - "UIDefaults contains CSS-derived ColorUIResource values after L&F activation"
    - "L&F returns correct metadata: name='DWC', ID='DwcLaf', isSupportedLookAndFeel=true"
    - "Maven JAR has zero external runtime dependencies"
  artifacts:
    - path: "src/main/java/com/dwc/laf/DwcLookAndFeel.java"
      provides: "Main L&F entry point extending BasicLookAndFeel"
      contains: "class DwcLookAndFeel extends BasicLookAndFeel"
      exports: ["getName", "getID", "getDescription", "isNativeLookAndFeel", "isSupportedLookAndFeel", "getTokenMap"]
    - path: "src/test/java/com/dwc/laf/DwcLookAndFeelTest.java"
      provides: "Integration tests proving L&F activation and UIDefaults population"
      contains: "UIManager.setLookAndFeel"
  key_links:
    - from: "src/main/java/com/dwc/laf/DwcLookAndFeel.java"
      to: "src/main/java/com/dwc/laf/css/CssThemeLoader.java"
      via: "CssThemeLoader.load() called in initComponentDefaults"
      pattern: "CssThemeLoader\\.load\\(\\)"
    - from: "src/main/java/com/dwc/laf/DwcLookAndFeel.java"
      to: "src/main/java/com/dwc/laf/defaults/UIDefaultsPopulator.java"
      via: "UIDefaultsPopulator.populate() called with loaded tokens and mapping"
      pattern: "UIDefaultsPopulator\\.populate\\("
    - from: "src/main/java/com/dwc/laf/DwcLookAndFeel.java"
      to: "src/main/java/com/dwc/laf/defaults/TokenMappingConfig.java"
      via: "TokenMappingConfig.loadDefault() called to load mapping config"
      pattern: "TokenMappingConfig\\.loadDefault\\(\\)"
    - from: "src/test/java/com/dwc/laf/DwcLookAndFeelTest.java"
      to: "javax.swing.UIManager"
      via: "UIManager.setLookAndFeel(new DwcLookAndFeel()) activation test"
      pattern: "UIManager\\.setLookAndFeel"
---

<objective>
Create the DwcLookAndFeel class that wires together CssThemeLoader, TokenMappingConfig, and UIDefaultsPopulator into a functional BasicLookAndFeel extension, activatable via standard UIManager.setLookAndFeel() API.

Purpose: This is the user-facing entry point. After this plan, any Swing application can activate the DWC L&F with a single line: `UIManager.setLookAndFeel(new DwcLookAndFeel())`. The L&F will automatically load the bundled CSS theme and populate UIDefaults with CSS-derived values.

Output: DwcLookAndFeel.java (main L&F class) and integration tests proving end-to-end activation and UIDefaults population from real CSS tokens.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-uidefaults-bridge-laf-setup/02-RESEARCH.md
@.planning/phases/02-uidefaults-bridge-laf-setup/02-01-SUMMARY.md
@src/main/java/com/dwc/laf/css/CssThemeLoader.java
@src/main/java/com/dwc/laf/css/CssTokenMap.java
@src/main/java/com/dwc/laf/defaults/TokenMappingConfig.java
@src/main/java/com/dwc/laf/defaults/UIDefaultsPopulator.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: DwcLookAndFeel class extending BasicLookAndFeel</name>
  <files>
    src/main/java/com/dwc/laf/DwcLookAndFeel.java
  </files>
  <action>
Create the main L&F entry point at `com.dwc.laf.DwcLookAndFeel`.

**DwcLookAndFeel.java** -- extends `javax.swing.plaf.basic.BasicLookAndFeel`:

Five required abstract method overrides:
- `getName()` returns `"DWC"`
- `getID()` returns `"DwcLaf"`
- `getDescription()` returns `"A Swing Look and Feel derived from DWC CSS design tokens"`
- `isNativeLookAndFeel()` returns `false`
- `isSupportedLookAndFeel()` returns `true`

Instance field:
- `private CssTokenMap tokenMap` -- stores the loaded token map for downstream access by custom painting code (future phases).

Override `initClassDefaults(UIDefaults table)`:
- Call `super.initClassDefaults(table)` FIRST (mandatory -- sets up Basic delegates, keyboard bindings).
- Do NOT register any custom ComponentUI delegates yet. Custom delegates do not exist until Phases 4-7. Registering class names that don't exist causes silent ClassNotFoundException fallback. Add a comment: `// Custom ComponentUI delegates registered in Phases 4-7`.

Override `initComponentDefaults(UIDefaults table)`:
- Call `super.initComponentDefaults(table)` FIRST (mandatory -- populates base fonts, colors, keyboard bindings).
- Load CSS tokens: `tokenMap = CssThemeLoader.load()`
- Load mapping config: `TokenMappingConfig mapping = TokenMappingConfig.loadDefault()`
- Populate UIDefaults: `UIDefaultsPopulator.populate(table, tokenMap, mapping)`
- After population, also set the default font using the mapped font family and size from UIDefaults. Check if `defaultFont.family` and `defaultFont.size` keys were populated. If so, resolve the font family string to a platform-available font name (implement a private `resolveFontFamily(String cssFontStack)` method that: splits on comma, trims quotes, maps CSS generic names to Java logical names ("sans-serif" -> "SansSerif", "serif" -> "Serif", "monospace" -> "Monospaced"), maps "-apple-system"/"BlinkMacSystemFont" to platform equivalents, checks `GraphicsEnvironment.getLocalGraphicsEnvironment().getAvailableFontFamilyNames()` for each candidate, returns "SansSerif" as ultimate fallback). Create a `FontUIResource` with the resolved family, font style from `defaultFont.style` if present (else Font.PLAIN), and size. Put it as: `table.put("defaultFont", fontResource)`. Also put it for common component font keys: `Button.font`, `Label.font`, `TextField.font`, `TextArea.font`, `ComboBox.font`, `CheckBox.font`, `RadioButton.font`, `TabbedPane.font`, `List.font`, `Table.font`, `ToolTip.font`, `MenuBar.font`, `Menu.font`, `MenuItem.font`.

Public accessor:
- `public CssTokenMap getTokenMap()` -- returns the loaded CssTokenMap. Useful for custom ComponentUI delegates in future phases that need direct token access for painting.

Use `java.util.logging.Logger` for any warnings.

IMPORTANT per research Pitfall 2: Do NOT register custom ComponentUI delegate class names in initClassDefaults. The delegate classes don't exist yet. Only call super.
  </action>
  <verify>
`mvn compile -f /Users/beff/_lab/dwclaf/pom.xml` compiles without errors. Verify DwcLookAndFeel.java exists at expected path and extends BasicLookAndFeel.
  </verify>
  <done>
DwcLookAndFeel extends BasicLookAndFeel, implements all 5 abstract methods, wires CssThemeLoader -> TokenMappingConfig -> UIDefaultsPopulator in initComponentDefaults, resolves CSS font-family to platform font, exposes getTokenMap() for downstream use.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests proving L&F activation and UIDefaults population</name>
  <files>
    src/test/java/com/dwc/laf/DwcLookAndFeelTest.java
  </files>
  <action>
Create comprehensive integration tests that verify the full pipeline: L&F activation -> CSS loading -> mapping -> UIDefaults population.

**DwcLookAndFeelTest.java** -- JUnit 5 tests. Since L&F tests modify global UIManager state, each test should save and restore the previous L&F in @BeforeEach/@AfterEach to avoid test pollution.

Tests:

1. **lafMetadata** -- `getName()` returns "DWC", `getID()` returns "DwcLaf", `getDescription()` is non-null/non-empty, `isNativeLookAndFeel()` is false, `isSupportedLookAndFeel()` is true.

2. **lafActivatesViaUIManager** -- `UIManager.setLookAndFeel(new DwcLookAndFeel())` does not throw. `UIManager.getLookAndFeel()` returns instance with name "DWC".

3. **lafPopulatesColorUIDefaults** -- After activation, `UIManager.getColor("Panel.background")` is not null. The returned Color is `instanceof ColorUIResource` (critical UIResource contract). `UIManager.getColor("Label.foreground")` is not null and is ColorUIResource.

4. **lafPopulatesPrimaryColor** -- After activation, `UIManager.getColor("Button.default.background")` is not null. This proves the --dwc-color-primary token was mapped through the pipeline.

5. **lafPopulatesIntegerDefaults** -- After activation, check that arc-related keys are populated: `UIManager.getInt("Component.arc")` or `UIManager.get("Component.arc")` returns a non-null Integer. `UIManager.get("Component.focusWidth")` returns a non-null Integer.

6. **lafPopulatesFont** -- After activation, `UIManager.getFont("defaultFont")` is not null. The returned Font is `instanceof FontUIResource`. Font size is > 0. Font family is not null/empty.

7. **lafTokenMapAccessible** -- After activation, cast `UIManager.getLookAndFeel()` to `DwcLookAndFeel`, call `getTokenMap()`, verify non-null and `size() > 0`.

8. **lafPopulatesMultipleKeysFromSingleToken** -- After activation, verify that a one-to-many token like --dwc-border-radius populates both `Button.arc` and `Component.arc` with the same value. Both should be non-null and equal.

9. **lafNoExternalDependencies** -- Verify the compiled classes don't import anything outside `java.*`, `javax.*`, `com.dwc.laf.*`. (This can be a simple assertion that the L&F class can be loaded and instantiated without any classpath additions beyond the JDK.)

10. **lafSwitchable** -- Activate DwcLookAndFeel, verify it's active, then switch to UIManager.getCrossPlatformLookAndFeelClassName() (Metal). Verify the switch succeeds. This proves UIResource wrapping is correct (Swing can replace the values).

Note: Some tests may need to be run with a headless AWT environment. Add `@BeforeAll static void setHeadless() { System.setProperty("java.awt.headless", "true"); }` if tests run in CI without display. But since Swing UIDefaults can be queried without a display, this should work in headless mode.
  </action>
  <verify>
Run `mvn test -pl . -Dtest="com.dwc.laf.DwcLookAndFeelTest" -f /Users/beff/_lab/dwclaf/pom.xml` -- all tests pass.
Run full suite: `mvn test -f /Users/beff/_lab/dwclaf/pom.xml` -- all tests pass (Phase 1 + all Phase 2 tests).
Verify: `mvn package -f /Users/beff/_lab/dwclaf/pom.xml` produces JAR successfully with zero external runtime dependencies.
  </verify>
  <done>
DwcLookAndFeel activates via UIManager.setLookAndFeel(), populates UIDefaults with CSS-derived ColorUIResource/Integer/Float/FontUIResource values, supports L&F switching (UIResource contract verified), exposes CssTokenMap for downstream delegates. Maven builds single JAR with zero external runtime dependencies. All phase success criteria met.
  </done>
</task>

</tasks>

<verification>
1. `UIManager.setLookAndFeel(new DwcLookAndFeel())` succeeds without exception (LAF-04)
2. `UIManager.getLookAndFeel().getName()` returns "DWC" (LAF-01)
3. `UIManager.getColor("Panel.background")` returns non-null ColorUIResource (LAF-03)
4. `UIManager.getFont("defaultFont")` returns non-null FontUIResource (LAF-03)
5. `mvn package` produces JAR with bundled CSS and mapping resources (BUILD-01, BUILD-02)
6. `mvn dependency:tree` shows only JUnit in test scope, no runtime deps (BUILD-03)
7. Full test suite passes: `mvn test -f /Users/beff/_lab/dwclaf/pom.xml`
</verification>

<success_criteria>
- L&F extends BasicLookAndFeel (LAF-01)
- L&F loads bundled light theme CSS on initialization (LAF-02)
- L&F populates UIDefaults from parsed CSS tokens via mapping layer (LAF-03)
- L&F activates via standard UIManager.setLookAndFeel() (LAF-04)
- Maven builds single JAR with bundled CSS as classpath resource (BUILD-01, BUILD-02)
- JAR works on Java 21+ with zero external runtime dependencies (BUILD-03)
</success_criteria>

<output>
After completion, create `.planning/phases/02-uidefaults-bridge-laf-setup/02-02-SUMMARY.md`
</output>
