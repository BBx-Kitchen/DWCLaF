---
phase: 04-button-component
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/com/dwc/laf/ui/DwcButtonBorder.java
  - src/main/resources/com/dwc/laf/token-mapping.properties
  - src/main/java/com/dwc/laf/DwcLookAndFeel.java
  - src/test/java/com/dwc/laf/ui/DwcButtonBorderTest.java
autonomous: true

must_haves:
  truths:
    - "DwcButtonBorder returns insets that include focusWidth + borderWidth + margin on all sides"
    - "DwcButtonBorder paints a rounded outline using PaintUtils.paintOutline within the focusWidth offset area"
    - "DwcButtonBorder respects application-set margins (non-UIResource) over default margins"
    - "Focus ring color is computed from CSS HSL tokens and stored in UIDefaults as Button.focusRingColor"
    - "Button border color is mapped from CSS token to Button.borderColor in UIDefaults"
  artifacts:
    - path: "src/main/java/com/dwc/laf/ui/DwcButtonBorder.java"
      provides: "Custom border with focus-width-aware insets and outline painting"
      min_lines: 60
    - path: "src/test/java/com/dwc/laf/ui/DwcButtonBorderTest.java"
      provides: "Tests for insets calculation and border painting"
      min_lines: 40
  key_links:
    - from: "src/main/java/com/dwc/laf/ui/DwcButtonBorder.java"
      to: "PaintUtils.paintOutline"
      via: "import and direct call in paintBorder()"
      pattern: "PaintUtils\\.paintOutline"
    - from: "src/main/java/com/dwc/laf/ui/DwcButtonBorder.java"
      to: "UIManager"
      via: "reads Component.focusWidth, Component.borderWidth, Button.arc, Button.borderColor"
      pattern: "UIManager\\.get(Int|Color)"
    - from: "src/main/java/com/dwc/laf/DwcLookAndFeel.java"
      to: "UIDefaults"
      via: "initComponentDefaults computes and stores Button.focusRingColor, Button.margin, Button.minimumWidth"
      pattern: "table\\.put.*focusRingColor"
    - from: "src/main/resources/com/dwc/laf/token-mapping.properties"
      to: "UIDefaults"
      via: "maps --dwc-button-border-color to Button.borderColor"
      pattern: "dwc-button-border-color.*Button\\.borderColor"
---

<objective>
Create DwcButtonBorder with focus-width-aware insets and outline painting, add missing token mappings, and wire button-specific UIDefaults (focus ring color, margin, minimumWidth) into DwcLookAndFeel.

Purpose: The button border is a prerequisite for DwcButtonUI -- it reserves space for the focus ring in the component layout and paints the border outline. The token mappings and computed UIDefaults values are needed at runtime for the delegate to read colors and dimensions.

Output: DwcButtonBorder class, updated token-mapping.properties, updated DwcLookAndFeel with button-specific component defaults.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-button-component/04-RESEARCH.md
@src/main/java/com/dwc/laf/DwcLookAndFeel.java
@src/main/java/com/dwc/laf/painting/PaintUtils.java
@src/main/java/com/dwc/laf/painting/FocusRingPainter.java
@src/main/java/com/dwc/laf/painting/StateColorResolver.java
@src/main/resources/com/dwc/laf/token-mapping.properties
@src/main/resources/com/dwc/laf/themes/default-light.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: DwcButtonBorder with focus-width-aware insets and outline painting</name>
  <files>
    src/main/java/com/dwc/laf/ui/DwcButtonBorder.java
    src/test/java/com/dwc/laf/ui/DwcButtonBorderTest.java
  </files>
  <action>
Create `DwcButtonBorder` extending `AbstractBorder` in `com.dwc.laf.ui` package.

**getBorderInsets(Component c, Insets insets):**
- Read `Component.focusWidth` (int) and `Component.borderWidth` (int) from UIManager
- Default margin: `new Insets(2, 14, 2, 14)` (matches FlatLaf/DWC button padding)
- If `c instanceof AbstractButton ab`, check `ab.getMargin()` -- if non-null AND NOT instanceof `javax.swing.plaf.UIResource`, use the application-set margin instead of default
- Calculate each side: `focusWidth + borderWidth + margin.{side}`
- Return the mutated insets object

**paintBorder(Component c, Graphics g, int x, int y, int width, int height):**
- Read `Component.focusWidth` (int), `Component.borderWidth` (int), `Button.arc` (int), `Button.borderColor` (Color) from UIManager
- If borderColor is null, return without painting
- If `c instanceof AbstractButton ab && !ab.isBorderPainted()`, return without painting
- Create `Graphics2D g2 = (Graphics2D) g.create()` in try-finally with `g2.dispose()`
- Call `PaintUtils.setupPaintingHints(g2)`, save result
- Set g2 color to borderColor
- Call `PaintUtils.paintOutline(g2, focusWidth, focusWidth, width - focusWidth * 2, height - focusWidth * 2, borderWidth, arc)` -- painting the outline in the content area (inside the focus ring space)
- Call `PaintUtils.restorePaintingHints(g2, saved)`

**Tests (DwcButtonBorderTest):**
- Test insets include focusWidth + borderWidth + margin (set up UIDefaults with known values, verify all four sides)
- Test application-set margin (non-UIResource) overrides default margin
- Test UIResource margin does NOT override default margin (uses default)
- Test paintBorder calls through without error when borderColor is set in UIDefaults
- Test paintBorder is no-op when borderColor is null
- Use `@BeforeEach` to set UIDefaults values, `@AfterEach` to clean up
  </action>
  <verify>`mvn test -pl . -Dtest="com.dwc.laf.ui.DwcButtonBorderTest" -Dsurefire.useFile=false` passes all tests</verify>
  <done>DwcButtonBorder.getBorderInsets returns focusWidth+borderWidth+margin on all sides; paintBorder renders outline via PaintUtils; 5+ tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Token mapping additions and button-specific UIDefaults in DwcLookAndFeel</name>
  <files>
    src/main/resources/com/dwc/laf/token-mapping.properties
    src/main/java/com/dwc/laf/DwcLookAndFeel.java
  </files>
  <action>
**token-mapping.properties additions:**
Add after the existing button token mappings:
```
--dwc-button-border-color = color:Button.borderColor
```
This maps the DWC button border color token (which resolves to `--dwc-color-default` in light theme) to `Button.borderColor` for UIDefaults.

**DwcLookAndFeel.initComponentDefaults updates:**
After the existing `initDefaultFont(table)` call, add a new method call `initButtonDefaults(table)`.

**initButtonDefaults(UIDefaults table) method:**
1. **Focus ring color computation:** The DWC focus ring color is `hsla(primary-h, primary-s, 45%, 0.4)`. The CSS token `--dwc-color-primary-h` resolves to `211` and `--dwc-color-primary-s` to `100%` in the default theme. Compute this programmatically:
   - Get `tokenMap` (already loaded as instance field)
   - Read `--dwc-color-primary-h` as float from tokenMap (hue, e.g. 211)
   - Read `--dwc-color-primary-s` as string from tokenMap, strip `%`, parse as float (e.g. 100)
   - Read `--dwc-focus-ring-l` as string from tokenMap, strip `%`, parse as float (e.g. 45)
   - Read `--dwc-focus-ring-a` as float from tokenMap (e.g. 0.4)
   - Convert HSL to RGB using the same algorithm as CssColorParser (hue/360, s/100, l/100): `q = l < 0.5 ? l * (1 + s) : l + s - l * s`, `p = 2 * l - q`, then hueToRgb for R, G, B channels
   - Create `new Color(r, g, b, (int)(alpha * 255))` and wrap in `ColorUIResource`
   - `table.put("Component.focusRingColor", focusRingColor)` -- use Component-level key so all components share it
   - If any token is missing, log a warning and skip (don't crash)

2. **Button margin:** `table.put("Button.margin", new javax.swing.plaf.InsetsUIResource(2, 14, 2, 14))` -- matches FlatLaf/DWC button padding

3. **Button minimum width:** `table.put("Button.minimumWidth", 72)` -- matches FlatLaf default

4. **Button icon-text gap:** `table.put("Button.iconTextGap", 4)` -- standard Swing gap

5. **Rollover enabled:** `table.put("Button.rollover", Boolean.TRUE)` -- ensures rollover events are tracked for hover state

**hueToRgb helper (private static):** Same algorithm as CssColorParser uses internally. Takes (p, q, t) and returns float 0-1:
```java
if (t < 0) t += 1;
if (t > 1) t -= 1;
if (t < 1.0/6) return p + (q - p) * 6 * t;
if (t < 1.0/2) return q;
if (t < 2.0/3) return p + (q - p) * (2.0/3 - t) * 6;
return p;
```

**Important:** The CssTokenMap API exposes `getInt()`, `getFloat()`, `getString()`, `getColor()`. For `--dwc-color-primary-h` (value: "211"), use `getInt("--dwc-color-primary-h")` or `getFloat()`. For percentage strings like "100%", use `getString()` and manually strip the `%` suffix before parsing. Check the actual resolved values in the token map since the CSS variable resolver would have expanded them.

**Do NOT move or duplicate CssColorParser's HSL logic -- just write a small private hslToColor helper in DwcLookAndFeel with the same algorithm for this specific use case (4 known float inputs).**
  </action>
  <verify>`mvn test -Dsurefire.useFile=false` -- all existing tests still pass (no regressions). Verify programmatically: create a small test or add to DwcLookAndFeelTest that after L&F activation, `UIManager.getColor("Component.focusRingColor")` is non-null and has alpha < 255, `UIManager.getInsets("Button.margin")` equals (2,14,2,14), `UIManager.getInt("Button.minimumWidth")` == 72.</verify>
  <done>token-mapping.properties has Button.borderColor mapping; DwcLookAndFeel computes focus ring color from CSS HSL tokens and stores it plus margin/minimumWidth/iconTextGap/rollover in UIDefaults; all tests pass</done>
</task>

</tasks>

<verification>
1. `mvn test -Dsurefire.useFile=false` -- all tests pass (existing + new DwcButtonBorderTest + updated DwcLookAndFeelTest)
2. DwcButtonBorder insets include focusWidth (3) + borderWidth (1) + margin (2,14,2,14) = (6,18,6,18) with default theme values
3. `UIManager.getColor("Component.focusRingColor")` returns a semi-transparent blue color after L&F activation
4. `UIManager.getColor("Button.borderColor")` returns non-null after L&F activation
</verification>

<success_criteria>
- DwcButtonBorder correctly computes insets and paints border outline
- Focus ring color derived from CSS HSL tokens and available via UIDefaults
- Button.borderColor mapped from CSS tokens
- Button.margin, Button.minimumWidth, Button.iconTextGap, Button.rollover set in UIDefaults
- All tests pass with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-button-component/04-01-SUMMARY.md`
</output>
