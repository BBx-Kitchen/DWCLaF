---
phase: 10-more-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/resources/com/dwc/laf/token-mapping.properties
  - src/main/java/com/dwc/laf/DwcLookAndFeel.java
  - src/main/java/com/dwc/laf/ui/DwcToolTipUI.java
  - src/main/java/com/dwc/laf/ui/DwcToolTipBorder.java
  - src/main/java/com/dwc/laf/ui/DwcProgressBarUI.java
  - src/test/java/com/dwc/laf/ui/DwcToolTipUITest.java
  - src/test/java/com/dwc/laf/ui/DwcProgressBarUITest.java
autonomous: true

must_haves:
  truths:
    - "JToolTip renders with rounded corners, themed background/foreground, and drop shadow"
    - "JProgressBar renders with rounded track and rounded fill bar from CSS tokens"
    - "JProgressBar supports color variants (success, danger, warning, info) via client property"
    - "JProgressBar indeterminate mode renders a bouncing rounded bar"
  artifacts:
    - path: "src/main/java/com/dwc/laf/ui/DwcToolTipUI.java"
      provides: "JToolTip UI delegate with custom background painting"
      exports: ["createUI"]
    - path: "src/main/java/com/dwc/laf/ui/DwcToolTipBorder.java"
      provides: "Rounded border with shadow insets for tooltip"
      exports: ["getBorderInsets", "paintBorder"]
    - path: "src/main/java/com/dwc/laf/ui/DwcProgressBarUI.java"
      provides: "JProgressBar UI delegate with determinate and indeterminate painting"
      exports: ["createUI"]
  key_links:
    - from: "DwcLookAndFeel.java"
      to: "DwcToolTipUI"
      via: "initClassDefaults ToolTipUI registration"
      pattern: 'table.put\("ToolTipUI"'
    - from: "DwcLookAndFeel.java"
      to: "DwcProgressBarUI"
      via: "initClassDefaults ProgressBarUI registration"
      pattern: 'table.put\("ProgressBarUI"'
    - from: "DwcToolTipUI.java"
      to: "ShadowPainter"
      via: "DwcToolTipBorder uses ShadowPainter for shadow rendering"
      pattern: "ShadowPainter.paintShadow"
    - from: "DwcProgressBarUI.java"
      to: "PaintUtils"
      via: "Rounded shape creation and filling"
      pattern: "PaintUtils.createRoundedShape"
---

<objective>
Implement JToolTip and JProgressBar UI delegates -- the two simplest components in Phase 10.

Purpose: These are the lowest-complexity new components and establish the Phase 10 pattern of adding token mappings, L&F init methods, class registrations, UI delegates, and tests for each component.

Output: Two fully functional themed components (tooltip with shadow, progress bar with variants) registered in DwcLookAndFeel.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-more-controls/10-RESEARCH.md
@src/main/java/com/dwc/laf/DwcLookAndFeel.java
@src/main/java/com/dwc/laf/ui/DwcButtonUI.java
@src/main/java/com/dwc/laf/ui/DwcButtonBorder.java
@src/main/java/com/dwc/laf/painting/PaintUtils.java
@src/main/java/com/dwc/laf/painting/ShadowPainter.java
@src/main/resources/com/dwc/laf/token-mapping.properties
@src/test/java/com/dwc/laf/ui/DwcButtonUITest.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: DwcToolTipUI + DwcToolTipBorder with shadow and rounded corners</name>
  <files>
    src/main/resources/com/dwc/laf/token-mapping.properties
    src/main/java/com/dwc/laf/DwcLookAndFeel.java
    src/main/java/com/dwc/laf/ui/DwcToolTipUI.java
    src/main/java/com/dwc/laf/ui/DwcToolTipBorder.java
    src/test/java/com/dwc/laf/ui/DwcToolTipUITest.java
  </files>
  <action>
    1. **Token mappings** in `token-mapping.properties`:
       - Append to `--dwc-surface-3` line: `, color:ToolTip.background`
       - Append to `--dwc-color-body-text` line: `, color:ToolTip.foreground`
       - Append to `--dwc-color-default-dark` line: `, color:ToolTip.borderColor`

    2. **DwcToolTipBorder.java** -- Custom border providing shadow insets and painting:
       - Extend `javax.swing.border.AbstractBorder`
       - Constants: `SHADOW_SIZE = 6`, `ARC = 8` (reasonable tooltip arc)
       - `getBorderInsets(Component c)`: return `new Insets(SHADOW_SIZE + 4, SHADOW_SIZE + 8, SHADOW_SIZE + 4, SHADOW_SIZE + 8)` -- shadow space + padding
       - `paintBorder(Component c, Graphics g, int x, int y, int w, int h)`:
         - Create `Graphics2D g2 = (Graphics2D) g.create()` in try-finally with dispose
         - Compute content area: `cx = x + SHADOW_SIZE`, `cy = y + SHADOW_SIZE`, `cw = w - SHADOW_SIZE * 2`, `ch = h - SHADOW_SIZE * 2`
         - Call `ShadowPainter.paintShadow(g2, cx, cy, cw, ch, ARC, 4f, 0, 2, shadowColor)` -- shadowColor = `UIManager.getColor("Panel.shadowColor")` or `new Color(0, 0, 0, 40)` fallback
         - Paint rounded border outline using `PaintUtils.setupPaintingHints(g2)`, `g2.setColor(borderColor)`, `PaintUtils.paintOutline(g2, cx, cy, cw, ch, 1f, ARC)`, `PaintUtils.restorePaintingHints(g2, saved)`
         - Read `borderColor` from `UIManager.getColor("ToolTip.borderColor")`; fallback to `Color.GRAY`
       - `isBorderOpaque()`: return `false`

    3. **DwcToolTipUI.java** -- UI delegate extending BasicToolTipUI:
       - `public static ComponentUI createUI(JComponent c)` returning `new DwcToolTipUI()` (per-component instance)
       - Private fields: `Color background`, `Color foreground`, `int arc = 8`
       - `installDefaults(JComponent c)`:
         - Call `super.installDefaults(c)`
         - Cache `background = UIManager.getColor("ToolTip.background")`, `foreground = UIManager.getColor("ToolTip.foreground")`
         - Set `LookAndFeel.installProperty(c, "opaque", false)` -- custom painting handles background
         - Install border: `if (c.getBorder() == null || c.getBorder() instanceof UIResource)` then `c.setBorder(new DwcToolTipBorder())`
       - `paint(Graphics g, JComponent c)`:
         - Do NOT call super.paint() -- full custom paint
         - Create `Graphics2D g2 = (Graphics2D) g.create()` in try-finally
         - Get border insets via `c.getInsets()`
         - Compute content area inside border insets
         - Compute inner rectangle (inside shadow): `ix = SHADOW_SIZE`, `iy = SHADOW_SIZE`, `iw = c.getWidth() - SHADOW_SIZE*2`, `ih = c.getHeight() - SHADOW_SIZE*2`
         - Paint rounded background: `PaintUtils.paintRoundedBackground(g2, ix, iy, iw, ih, arc, background)`
         - Paint text: get `JToolTip.getTipText()`, use `g2.setFont(c.getFont())`, set foreground, draw string with `SwingUtilities2` alternative: use `g2.setColor(foreground)`, `g2.drawString(tipText, textX, textY)` where textX/textY account for border insets + padding. Actually, simplest approach: call `super.paint(g, c)` AFTER painting the background, since BasicToolTipUI.paint() handles text layout. But BasicToolTipUI.paint() paints its own background too. Better approach: paint rounded background then delegate text to super. Since BasicToolTipUI.paint() fills background only if opaque (which we set to false), we can: paint rounded background, then call `super.paint(g, c)` which will paint text only (since opaque=false, it skips bg fill).
         - So: paint rounded background manually, then `super.paint(g, c)` for text rendering.
       - `getPreferredSize(JComponent c)`: call `super.getPreferredSize(c)` -- no override needed

    4. **DwcLookAndFeel.java** changes:
       - In `initClassDefaults()`: add `table.put("ToolTipUI", "com.dwc.laf.ui.DwcToolTipUI")`
       - In `initComponentDefaults()`: add call to `initToolTipDefaults(table)` after TabbedPane init
       - Create `private void initToolTipDefaults(UIDefaults table)`:
         - `table.put("ToolTip.border", new BorderUIResource(new DwcToolTipBorder()))`
         - Log "Initialized tooltip defaults (border)"

    5. **DwcToolTipUITest.java** -- tests following DwcButtonUITest pattern:
       - Save/restore L&F in @BeforeEach/@AfterEach
       - `testUIInstalled()`: create JToolTip, assert `getUI() instanceof DwcToolTipUI`
       - `testPerComponentInstance()`: two JToolTips have different UI instances
       - `testNotOpaque()`: tooltip is not opaque
       - `testBorderInstalled()`: border is `DwcToolTipBorder`
       - `testBorderInsets()`: insets account for shadow (all sides >= SHADOW_SIZE)
       - `testPaintNoError()`: set tipText, setSize, paint to BufferedImage without exception
  </action>
  <verify>
    `cd /Users/beff/_lab/dwclaf && mvn test -pl . -Dtest="DwcToolTipUITest" -q` passes all tests.
    Grep confirms ToolTipUI registered in DwcLookAndFeel: `grep "ToolTipUI" src/main/java/com/dwc/laf/DwcLookAndFeel.java`
  </verify>
  <done>
    JToolTip uses DwcToolTipUI with rounded background, themed colors from CSS tokens, and shadow via DwcToolTipBorder. Six tests pass confirming UI installation, per-component instances, border insets, and paint pipeline.
  </done>
</task>

<task type="auto">
  <name>Task 2: DwcProgressBarUI with rounded bars and color variants</name>
  <files>
    src/main/resources/com/dwc/laf/token-mapping.properties
    src/main/java/com/dwc/laf/DwcLookAndFeel.java
    src/main/java/com/dwc/laf/ui/DwcProgressBarUI.java
    src/test/java/com/dwc/laf/ui/DwcProgressBarUITest.java
  </files>
  <action>
    1. **Token mappings** in `token-mapping.properties`:
       - `--dwc-color-primary` line: already has `color:ProgressBar.foreground` -- confirm it exists
       - Append to `--dwc-color-default` line: `, color:ProgressBar.background`
       - Add new lines for variant foreground colors:
         ```
         --dwc-color-success = ..., color:ProgressBar.success.foreground
         --dwc-color-danger = ..., color:ProgressBar.danger.foreground
         --dwc-color-warning = ..., color:ProgressBar.warning.foreground
         --dwc-color-info = ..., color:ProgressBar.info.foreground
         ```
         BUT these tokens already have mappings. Append to existing lines:
         - Append `, color:ProgressBar.success.foreground` to the `--dwc-color-success` line
         - Append `, color:ProgressBar.danger.foreground` to the `--dwc-color-danger` line
         - Append `, color:ProgressBar.warning.foreground` to the `--dwc-color-warning` line
         - Append `, color:ProgressBar.info.foreground` to the `--dwc-color-info` line
       - Append to `--dwc-border-radius` line: `, int:ProgressBar.arc`

    2. **DwcProgressBarUI.java** -- extending BasicProgressBarUI:
       - `public static ComponentUI createUI(JComponent c)` returning `new DwcProgressBarUI()`
       - Private fields: `Color foreground`, `Color background`, `int arc`, `float disabledOpacity`, plus `Map<String, Color> variantForegrounds` for color variants
       - `installDefaults()`:
         - Call `super.installDefaults()` (lets BasicProgressBarUI set up animation timer)
         - Cache: `foreground = UIManager.getColor("ProgressBar.foreground")`, `background = UIManager.getColor("ProgressBar.background")`, `arc = UIManager.getInt("ProgressBar.arc")`
         - `disabledOpacity`: read from `UIManager.get("Component.disabledOpacity")` like DwcButtonUI does
         - Build `variantForegrounds` map: for each variant in ["success", "danger", "warning", "info"], read `UIManager.getColor("ProgressBar." + variant + ".foreground")`
       - `paintDeterminate(Graphics g, JComponent c)`:
         - Cast to JProgressBar. Get insets. Compute content area x,y,width,height.
         - `Graphics2D g2 = (Graphics2D) g.create()` in try-finally
         - `Object[] saved = PaintUtils.setupPaintingHints(g2)`
         - Paint track: `g2.setColor(background)`, `g2.fill(PaintUtils.createRoundedShape(x, y, width, height, arc))`
         - Compute fill width: `int amountFull = getAmountFull(insets, width, height)` -- this is a protected method from BasicProgressBarUI
         - If amountFull > 0:
           - Resolve fill color via `resolveVariantColor(pb)` helper
           - Create track shape and fill shape (both rounded)
           - Use `java.awt.geom.Area` intersection: `Area fillArea = new Area(fillShape); fillArea.intersect(new Area(trackShape)); g2.fill(fillArea)` -- this clips the fill to the track's rounded corners
         - If `pb.isStringPainted()`: paint percentage text centered (use `pb.getString()`, font metrics for centering)
         - `PaintUtils.restorePaintingHints(g2, saved)`
         - If disabled: wrap entire painting in `StateColorResolver.paintWithOpacity(g2, disabledOpacity, () -> { ... })`
       - `paintIndeterminate(Graphics g, JComponent c)`:
         - Similar to determinate but instead of amountFull, use `getBox(boxRect)` from BasicProgressBarUI to get the bouncing box position
         - Paint track background, then paint the bouncing rounded rect (clipped to track shape via Area intersection)
         - Use `resolveVariantColor(pb)` for the bouncing bar color
       - `resolveVariantColor(JProgressBar pb)`:
         - Read `Object prop = pb.getClientProperty("dwc.progressType")`
         - If prop instanceof String and variantForegrounds contains it, return that color
         - Else return `this.foreground` (default primary color)
       - `getPreferredSize(JComponent c)`: call super, ensure minimum height of 8px for thin bar look (do not enforce 36px like button)

    3. **DwcLookAndFeel.java** changes:
       - In `initClassDefaults()`: add `table.put("ProgressBarUI", "com.dwc.laf.ui.DwcProgressBarUI")`
       - In `initComponentDefaults()`: add call to `initProgressBarDefaults(table)` after tooltip init
       - Create `private void initProgressBarDefaults(UIDefaults table)`:
         - `table.put("ProgressBar.border", new BorderUIResource(BorderFactory.createEmptyBorder()))` -- no visible border
         - If `table.get("ProgressBar.arc") == null`: `table.put("ProgressBar.arc", table.getInt("Component.arc"))` -- inherit from global arc
         - Log "Initialized progress bar defaults"

    4. **DwcProgressBarUITest.java** -- tests following established pattern:
       - Save/restore L&F
       - `testUIInstalled()`: JProgressBar uses DwcProgressBarUI
       - `testPerComponentInstance()`: two bars have different UI instances
       - `testPaintDeterminateNoError()`: set value=50, setSize, paint to BufferedImage
       - `testPaintIndeterminateNoError()`: `pb.setIndeterminate(true)`, paint to BufferedImage
       - `testSuccessVariantPaintNoError()`: `putClientProperty("dwc.progressType", "success")`, paint
       - `testDangerVariantPaintNoError()`: danger variant paint smoke test
       - `testWarningVariantPaintNoError()`: warning variant paint smoke test
       - `testInfoVariantPaintNoError()`: info variant paint smoke test
       - `testVariantColorsDifferFromDefault()`: compare center pixel of default vs success variant (same pattern as DwcButtonUITest.testVariantColorsDifferFromDefault)
  </action>
  <verify>
    `cd /Users/beff/_lab/dwclaf && mvn test -pl . -Dtest="DwcProgressBarUITest" -q` passes all tests.
    `cd /Users/beff/_lab/dwclaf && mvn test -q` -- full suite still passes (no regressions).
  </verify>
  <done>
    JProgressBar uses DwcProgressBarUI with rounded track/fill, themed colors from CSS tokens, color variant support via dwc.progressType client property, and indeterminate animation. Nine tests pass. Full test suite green.
  </done>
</task>

</tasks>

<verification>
- `mvn test -q` passes all tests (existing + new tooltip + progress bar tests)
- `grep "ToolTipUI\|ProgressBarUI" src/main/java/com/dwc/laf/DwcLookAndFeel.java` shows both registered
- Token-mapping.properties has ToolTip.background, ToolTip.foreground, ToolTip.borderColor, ProgressBar.background, ProgressBar.arc, and ProgressBar.{variant}.foreground entries
</verification>

<success_criteria>
- DwcToolTipUI installed and painting rounded tooltips with shadow border
- DwcProgressBarUI installed with determinate, indeterminate, and 4 color variants
- All new tests pass, all existing tests pass
- Both components registered in DwcLookAndFeel.initClassDefaults()
- Token mappings correctly appended to existing lines (no duplicate definitions)
</success_criteria>

<output>
After completion, create `.planning/phases/10-more-controls/10-01-SUMMARY.md`
</output>
