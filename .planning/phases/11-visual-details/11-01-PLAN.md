---
phase: 11-visual-details
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/resources/com/dwc/laf/token-mapping.properties
  - src/main/java/com/dwc/laf/ui/DwcProgressBarUI.java
  - src/main/java/com/dwc/laf/DwcLookAndFeel.java
  - src/main/java/com/dwc/laf/ui/DwcTextFieldBorder.java
  - src/main/java/com/dwc/laf/ui/DwcTextFieldUI.java
  - src/main/java/com/dwc/laf/ui/DwcTreeNodeIcon.java
  - src/main/java/com/dwc/laf/ui/DwcTreeUI.java
autonomous: true

must_haves:
  truths:
    - "ProgressBar fill has pill-shaped rounded ends matching the track shape"
    - "TextField border is flat with no visible bevel, shadow, or 3D effect"
    - "Tree nodes display both expand/collapse chevron AND a default folder/file icon"
    - "Custom tree node icons set by application code are preserved after L&F application"
  artifacts:
    - path: "src/main/java/com/dwc/laf/ui/DwcTreeNodeIcon.java"
      provides: "Programmatic folder/file icons for tree nodes"
      contains: "class DwcTreeNodeIcon implements Icon"
    - path: "src/main/resources/com/dwc/laf/token-mapping.properties"
      provides: "ProgressBar.arc mapped from --dwc-border-radius-xl"
      contains: "ProgressBar.arc"
    - path: "src/main/java/com/dwc/laf/DwcLookAndFeel.java"
      provides: "Tree.openIcon, Tree.closedIcon, Tree.leafIcon in UIDefaults"
      contains: "Tree.openIcon"
  key_links:
    - from: "src/main/java/com/dwc/laf/DwcLookAndFeel.java"
      to: "src/main/java/com/dwc/laf/ui/DwcTreeNodeIcon.java"
      via: "UIDefaults installation of tree node icons"
      pattern: "DwcTreeNodeIcon"
    - from: "src/main/resources/com/dwc/laf/token-mapping.properties"
      to: "src/main/java/com/dwc/laf/ui/DwcProgressBarUI.java"
      via: "ProgressBar.arc UIDefaults key"
      pattern: "ProgressBar\\.arc"
---

<objective>
Fix three visual rendering gaps: ProgressBar pill-shaped fill, TextField flat border verification/fix, and Tree node default icons.

Purpose: Close three of four rendering gaps between Swing L&F and DWC web to achieve visual parity for ProgressBar, TextField, and Tree components.
Output: Updated ProgressBar arc, verified/fixed TextField border, new DwcTreeNodeIcon class installed in UIDefaults.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-visual-details/11-RESEARCH.md
@src/main/java/com/dwc/laf/ui/DwcProgressBarUI.java
@src/main/java/com/dwc/laf/ui/DwcTextFieldBorder.java
@src/main/java/com/dwc/laf/ui/DwcTextFieldUI.java
@src/main/java/com/dwc/laf/ui/DwcTreeUI.java
@src/main/java/com/dwc/laf/ui/DwcTreeExpandIcon.java
@src/main/java/com/dwc/laf/DwcLookAndFeel.java
@src/main/resources/com/dwc/laf/token-mapping.properties
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ProgressBar pill-shaped fill and TextField flat border</name>
  <files>
    src/main/resources/com/dwc/laf/token-mapping.properties
    src/main/java/com/dwc/laf/ui/DwcProgressBarUI.java
    src/main/java/com/dwc/laf/DwcLookAndFeel.java
    src/main/java/com/dwc/laf/ui/DwcTextFieldBorder.java
    src/main/java/com/dwc/laf/ui/DwcTextFieldUI.java
  </files>
  <action>
    **ProgressBar fix:**
    1. In `token-mapping.properties`, remove `int:ProgressBar.arc` from the `--dwc-border-radius` line.
    2. Add a new mapping line: `--dwc-border-radius-xl = int:ProgressBar.arc` — this maps the DWC border-radius-xl token (0.75em = 12px) to ProgressBar.arc instead of the standard border-radius (4px). The CSS file already defines `--dwc-border-radius-xl: var(--dwc-border-radius-xl)` which resolves to `0.75em`.
    3. In `DwcLookAndFeel.initProgressBarDefaults()`, update the fallback: if the token-mapped ProgressBar.arc is still <= 0 after mapping, use a pill-shaped fallback of `999` (effectively height-based rounding, since `PaintUtils.createRoundedShape` clamps arc to min(width, height)). This ensures pill shape even if the token is missing.
    4. No changes needed in `DwcProgressBarUI.java` itself — it already reads `ProgressBar.arc` from UIManager and uses Area intersection clipping which handles large arcs correctly.

    **TextField border fix:**
    5. Run the gallery (`mvn compile exec:java`) and inspect the TextField border rendering. The research indicates the border is already mathematically flat via `PaintUtils.paintOutline` (even-odd fill creates a ring, not a 3D bevel).
    6. The likely "3D" visual is the background color difference: `--dwc-input-background` (hsl 211,38%,95% — slight blue tint) vs `--dwc-surface-3` (white panel). This IS correct DWC behavior.
    7. If the border truly appears 3D (has actual bevel/shadow beyond the color difference), check if `DwcTextFieldBorder.paintBorder()` or `DwcTextFieldUI.paintSafely()` has any stroke-based border rendering. Currently `paintOutline` uses even-odd fill which is definitionally flat — verify this by reading PaintUtils.paintOutline.
    8. If the border IS already flat, no code changes needed for TextField. The "3D" appearance is the intentional DWC input background tint.
    9. If there IS a bevel: ensure the background painted in `DwcTextFieldUI.paintSafely()` exactly fills the space inside the border outline (currently uses `PaintUtils.paintRoundedBackground` at focusWidth offset — this should be correct). Remove any residual shadow/bevel source.

    The research strongly suggests TextField is already correct. Document finding in the summary.
  </action>
  <verify>
    - `mvn compile -q` succeeds with no errors.
    - `grep "ProgressBar.arc" src/main/resources/com/dwc/laf/token-mapping.properties` shows it on the `--dwc-border-radius-xl` line, NOT on `--dwc-border-radius`.
    - `grep "border-radius-xl" src/main/resources/com/dwc/laf/token-mapping.properties` returns the new mapping line.
  </verify>
  <done>
    ProgressBar.arc now maps from --dwc-border-radius-xl (12px) instead of --dwc-border-radius (4px), producing pill-shaped track and fill. TextField border verified as flat (or fixed if not). Both compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add default tree node icons (folder/file)</name>
  <files>
    src/main/java/com/dwc/laf/ui/DwcTreeNodeIcon.java
    src/main/java/com/dwc/laf/DwcLookAndFeel.java
    src/main/java/com/dwc/laf/ui/DwcTreeUI.java
  </files>
  <action>
    **Create DwcTreeNodeIcon.java:**
    1. Create new file `src/main/java/com/dwc/laf/ui/DwcTreeNodeIcon.java` following the `DwcTreeExpandIcon` pattern.
    2. The class implements `javax.swing.Icon` with three types via an enum: `FOLDER_OPEN`, `FOLDER_CLOSED`, `FILE`.
    3. Icon size: 16x16 pixels (standard Swing tree icon size, larger than the 12x12 expand icon to visually distinguish).
    4. Color: read from `UIManager.getColor("Tree.expandedIcon.color")` with `Color.DARK_GRAY` fallback — same color source as `DwcTreeExpandIcon` for visual consistency.
    5. Use `PaintUtils.setupPaintingHints`/`restorePaintingHints` for antialiasing.
    6. Drawing approach — stroked outlines (not filled) for consistency with expand icon style:
       - **FOLDER_CLOSED:** Rectangle body (x+2, y+5, 12w, 8h) with a small tab flap on the top-left (x+2, y+3, 5w, 2h). Both stroked outlines using BasicStroke(1.2f, CAP_ROUND, JOIN_ROUND).
       - **FOLDER_OPEN:** Same as closed but with a slightly angled top-right portion to suggest the folder is open. Draw the base rectangle (x+2, y+5, 12w, 8h), then the tab (x+2, y+3, 5w, 2h), then an angled line from folder top-right corner toward lower-right to suggest the open flap.
       - **FILE:** Rectangle body (x+3, y+2, 10w, 12h) with a folded corner at top-right: draw the page rectangle minus the top-right corner, add a diagonal fold line from (x+10, y+2) to (x+13, y+5) then down. Use a Path2D for the page outline with the corner cut.
    7. All coordinates should be float-based for HiDPI correctness.

    **Install icons in DwcLookAndFeel.initTreeDefaults():**
    8. In `DwcLookAndFeel.java`, add import for `DwcTreeNodeIcon`.
    9. In `initTreeDefaults()`, add three lines after the existing expand/collapse icon setup:
       ```
       table.put("Tree.openIcon", new DwcTreeNodeIcon(DwcTreeNodeIcon.Type.FOLDER_OPEN));
       table.put("Tree.closedIcon", new DwcTreeNodeIcon(DwcTreeNodeIcon.Type.FOLDER_CLOSED));
       table.put("Tree.leafIcon", new DwcTreeNodeIcon(DwcTreeNodeIcon.Type.FILE));
       ```
    10. Update the LOG.fine message to include the new icon names.

    **Verify DwcTreeUI compatibility:**
    11. In `DwcTreeUI.installDefaults()`, verify that the `DefaultTreeCellRenderer` configuration block does NOT explicitly clear icons. Currently it only sets colors and removes the border selection color — this is fine. No changes needed in DwcTreeUI.java unless the renderer is explicitly setting icons to null (it isn't per current code).
    12. The fix works because: UIDefaults sets Tree.openIcon/closedIcon/leafIcon -> DefaultTreeCellRenderer constructor reads them -> icons are visible. User code calling `renderer.setLeafIcon()` etc. will override these defaults correctly.

    **IMPORTANT:** Only install icons in UIDefaults — do NOT set them directly on the renderer in DwcTreeUI. This preserves the UIResource contract: UIDefaults provides defaults, user code overrides them.
  </action>
  <verify>
    - `mvn compile -q` succeeds with no errors.
    - `grep -r "DwcTreeNodeIcon" src/main/java/` finds both the class file and the DwcLookAndFeel references.
    - `grep "Tree.openIcon\|Tree.closedIcon\|Tree.leafIcon" src/main/java/com/dwc/laf/DwcLookAndFeel.java` shows all three icon installations.
  </verify>
  <done>
    Tree nodes display default folder/file icons via UIDefaults. Icons are visible for all node types (open folder, closed folder, leaf file). Custom icons set by application code via DefaultTreeCellRenderer methods are preserved. Icons survive theme switching because they are installed in UIDefaults, not on individual renderer instances.
  </done>
</task>

</tasks>

<verification>
1. `mvn compile -q` succeeds with zero errors.
2. Run gallery (`mvn compile exec:java`) and visually confirm:
   - ProgressBar fill has pill-shaped rounded ends (not square left edge)
   - TextField border is flat (single-pixel outline, no 3D bevel)
   - Tree nodes show folder icons for parent nodes and file icon for leaf nodes
   - Tree expand/collapse chevrons still work alongside the new icons
3. All existing tests pass: `mvn test -q`
</verification>

<success_criteria>
- ProgressBar.arc comes from --dwc-border-radius-xl (12px) producing pill-shaped rendering
- TextField border confirmed flat (PaintUtils.paintOutline even-odd fill ring)
- DwcTreeNodeIcon class exists with FOLDER_OPEN, FOLDER_CLOSED, FILE types
- Tree.openIcon, Tree.closedIcon, Tree.leafIcon installed in UIDefaults
- All 3 fixes compile and integrate without affecting existing component rendering
</success_criteria>

<output>
After completion, create `.planning/phases/11-visual-details/11-01-SUMMARY.md`
</output>
